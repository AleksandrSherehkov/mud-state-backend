generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  MODERATOR
  USER
}

model User {
  id String @id @default(uuid()) @db.Uuid
  email         String         @unique @db.Citext
  password      String
  role          Role           @default(USER)
  characters    Character[]
  refreshTokens RefreshToken[]
  sessions      Session[]
  createdAt     DateTime       @default(now())
  security      UserSecurity?
}

model Character {
  id         String   @id @default(uuid()) @db.Uuid
  name       String
  race       String
  class      String
  stats      Json
  locationId String
  userId     String   @db.Uuid
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
}

model RefreshToken {
  jti       String   @id @db.Uuid
  tokenHash String   @db.VarChar(64)
  tokenSalt String  @db.VarChar(32)
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  revoked   Boolean  @default(false)
  expiresAt DateTime
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  sessions Session[] @relation("SessionToRefreshToken")

  @@index([userId, revoked, expiresAt])
  
  @@index([expiresAt])

}

model Session {
  id String @id @default(uuid()) @db.Uuid
  userId String @db.Uuid
  refreshTokenJti String? @db.Uuid
  refreshToken    RefreshToken? @relation("SessionToRefreshToken", fields: [refreshTokenJti], references: [jti], onDelete: SetNull)
  ip              String?
  userAgent       String?
  isActive        Boolean       @default(true)
  startedAt       DateTime      @default(now())
  endedAt         DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([refreshTokenJti])
  @@index([userId, isActive, endedAt, startedAt])
  @@index([userId, startedAt])

}

model UserSecurity {
  userId String @id @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  failedLoginCount Int       @default(0)
  lastFailedAt     DateTime?
  lockedUntil      DateTime?

  lastFailedIp     String?
  lastFailedUaHash String?

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([lockedUntil])
  @@index([lastFailedAt])
}
